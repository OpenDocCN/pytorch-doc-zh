# 在Windows上构建

> 原文：[https://pytorch.org/audio/stable/build.windows.html](https://pytorch.org/audio/stable/build.windows.html)

要在Windows上构建TorchAudio，我们需要启用C++编译器并安装构建工具和运行时依赖。

我们使用Microsoft Visual C++来编译C++代码，使用Conda来管理其他构建工具和运行时依赖。

## 1\. 安装构建工具[](#install-build-tools "此标题的永久链接")

### MSVC[](#msvc "此标题的永久链接")

请按照[https://visualstudio.microsoft.com/downloads/](https://visualstudio.microsoft.com/downloads/)上的说明操作，并确保安装了C++开发工具。

注意

官方的二进制发行版是使用MSVC 2019编译的。以下部分使用的路径来自于MSVC 2019社区版。

### Conda[](#conda "此标题的永久链接")

请按照[https://docs.conda.io/en/latest/miniconda.html](https://docs.conda.io/en/latest/miniconda.html)上的说明操作。

## 2\. 启动开发环境[](#start-the-dev-environment "此标题的永久链接")

在接下来的步骤中，我们需要使用C++编译器（`cl`）和Conda包管理器（`conda`）。我们还使用Bash以便与Linux/macOS有类似的体验。

为此，需要执行以下三个步骤。

1.  打开命令提示符

1.  启用开发环境

1.  [可选] 启动Bash

以下组合已知可行。

1.  启动Anaconda3命令提示符。

    [![https://download.pytorch.org/torchaudio/doc-assets/windows-conda.png](../Images/e359bffec700153e5b0c8c00a8b001f7.png)](https://download.pytorch.org/torchaudio/doc-assets/windows-conda.png)

    请确保`conda`命令被识别。

    [![https://download.pytorch.org/torchaudio/doc-assets/windows-conda2.png](../Images/13a95ff6452fc2a52bb6a6b9bf666630.png)](https://download.pytorch.org/torchaudio/doc-assets/windows-conda2.png)

1.  通过运行以下命令激活开发工具。

    我们需要使用MSVC x64工具集进行编译。要启用该工具集，可以使用`vcvarsall.bat`或`vcvars64.bat`文件，这些文件位于Visual Studio的安装文件夹下的`VC\Auxiliary\Build\`目录中。更多信息请参考[https://docs.microsoft.com/en-us/cpp/build/how-to-enable-a-64-bit-visual-cpp-toolset-on-the-command-line?view=msvc-160#use-vcvarsallbat-to-set-a-64-bit-hosted-build-architecture](https://docs.microsoft.com/en-us/cpp/build/how-to-enable-a-64-bit-visual-cpp-toolset-on-the-command-line?view=msvc-160#use-vcvarsallbat-to-set-a-64-bit-hosted-build-architecture)

    ```py
    call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build\vcvarsall.bat" x64 
    ```

    请确保`cl`命令被识别。

    [![https://download.pytorch.org/torchaudio/doc-assets/windows-msvc.png](../Images/323d3a6ff776378e8f39d87a6893379c.png)](https://download.pytorch.org/torchaudio/doc-assets/windows-msvc.png)

1.  [可选] 使用以下命令启动Bash。

    如果您想要与Linux/macOS类似的用户体验，可以启动Bash。但请注意，在Bash环境中，文件路径与本机Windows风格不同，并且`torchaudio.datasets`模块不起作用。

    ```py
    Miniconda3\Library\bin\bash.exe 
    ```

    [![https://download.pytorch.org/torchaudio/doc-assets/windows-bash.png](../Images/c02c1db4f464de7562d28e7eb2f1f87a.png)](https://download.pytorch.org/torchaudio/doc-assets/windows-bash.png)

## 3\. 安装PyTorch[](#install-pytorch "此标题的永久链接")

请参考[https://pytorch.org/get-started/locally/](https://pytorch.org/get-started/locally/)以获取安装PyTorch的最新方法。

以下命令安装PyTorch的夜间构建版本。

```py
# CPU-only
conda install pytorch cpuonly -c pytorch-nightly

# With CUDA support
conda install pytorch pytorch-cuda=11.7 -c pytorch-nightly -c nvidia 
```

在安装启用CUDA版本时，也会安装CUDA工具包。

## 4\. [可选] cuDNN[](#optional-cudnn "此标题的永久链接")

如果您打算构建与CUDA相关的功能，请安装cuDNN。

从[https://developer.nvidia.com/cudnn](https://developer.nvidia.com/cudnn)下载CuDNN，并将文件提取到与CUDA工具包相同的目录中。

使用conda时，目录为`${CONDA_PREFIX}/bin`，`${CONDA_PREFIX}/include`，`${CONDA_PREFIX}/Lib/x64`。

## 5. 安装外部依赖项

```py
conda install cmake ninja 
```

## 6. 构建TorchAudio

现在我们已经准备好了，可以构建TorchAudio了。

```py
git clone https://github.com/pytorch/audio
cd audio 
```

```py
# In Command Prompt
python setup.py develop 
```

```py
# In Bash
python setup.py develop 
```

注意

由于构建过程的复杂性，TorchAudio仅支持原地构建。要使用`pip`，请使用`--no-use-pep517`选项。

`pip install -v -e . --no-use-pep517`

## [可选] 使用自定义FFmpeg构建TorchAudio

默认情况下，torchaudio尝试构建支持多个FFmpeg版本的FFmpeg扩展。此过程使用为特定CPU架构编译的预构建FFmpeg库，如`x86_64`。

如果您的CPU不同，那么构建过程可能会失败。为了解决问题，可以禁用FFmpeg集成（通过设置环境变量`USE_FFMPEG=0`）或切换到单版本FFmpeg扩展。

要构建单版本FFmpeg扩展，用户必须提供FFmpeg二进制文件，并且在构建环境中可用。为此，请安装FFmpeg并设置`FFMPEG_ROOT`环境变量以指定FFmpeg的位置。

```py
conda install -c conda-forge ffmpeg
FFMPEG_ROOT=${CONDA_PREFIX}/Library python setup.py develop 
```

## [可选] 从源代码构建FFmpeg

以下部分说明了从源代码构建FFmpeg库的方法。

Conda-forge的FFmpeg软件包具有对主要编解码器和GPU解码器的支持，因此常规用户和开发人员不需要从源代码构建FFmpeg。

如果您不使用Conda，则可以找到预构建的二进制发行版，或者自己构建FFmpeg。

此外，如果torchaudio开发人员需要更新和定制FFmpeg构建的CI，本节可能会有所帮助。

### 1. 安装MSYS2

为了以一种在TorchAudio开发环境中可用的方式构建FFmpeg，我们需要构建适用于`MINGW64`的本机二进制文件。为此，我们需要FFmpeg构建过程所需的工具，如在`MINGW64`环境中工作的`pkg-config`和`make`。为此目的，我们使用MSYS2。

FFmpeg的官方文档涉及到这一点[https://trac.ffmpeg.org/wiki/CompilationGuide/MinGW](https://trac.ffmpeg.org/wiki/CompilationGuide/MinGW)

请按照[https://www.msys2.org/](https://www.msys2.org/)上的说明安装MSYS2。

注意

在CI环境中，通常可以使用[Chocolatery](https://chocolatey.org/)来安装MSYS2。

### 2. 启动MSYS2

使用快捷方式启动MSYS2（MINGW64）。

[![https://download.pytorch.org/torchaudio/doc-assets/windows-msys2.png](../Images/59237156547c1a97b95f4271157a9c1e.png)](https://download.pytorch.org/torchaudio/doc-assets/windows-msys2.png)

注意

MSYS2中的Bash环境与Conda环境不兼容，因此不要在MSYS2环境的`~/.bashrc`中添加Conda初始化脚本（即`C:\msys2\home\USER\.bashrc`）。而是将其添加到`C:\Users\USER\.bashrc`中。

### 3. 安装构建工具

```py
$ pacman -S mingw-w64-x86_64-make
$ pacman -S mingw-w64-x86_64-yasm 
```

安装完成后，您应该有类似以下的软件包;

```py
$ pacman -Qe
base 2020.12-1
base-devel 2022.01-2
filesystem 2023.01-2
mingw-w64-x86_64-make 4.3-1
mingw-w64-x86_64-pkgconf 1.8.0-2
mingw-w64-x86_64-yasm 1.3.0-4
msys2-runtime 3.4.3-5 
```

### 4. 构建FFmpeg

查看FFmpeg源代码。

```py
git clone https://github.com/ffmpeg/ffmpeg
cd ffmpeg
git checkout <VERSION> 
```

构建

```py
./configure --toolchain=msvc
make -j 
```

如果构建成功，`ffmpeg.exe`应该在同一目录中找到。确保您可以运行它。

### 5. 验证构建

检查生成的FFmpeg二进制文件是否可以从Conda环境访问。

现在启动一个新的命令提示符并启用TorchAudio开发环境。确保您可以运行在上一步生成的`ffmpeg.exe`命令。
