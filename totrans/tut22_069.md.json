["```py\nimport torch\nimport numpy as np\nfrom torch import nn\nimport torch.autograd.profiler as profiler \n```", "```py\nclass MyModule([nn.Module](https://pytorch.org/docs/stable/generated/torch.nn.Module.html#torch.nn.Module \"torch.nn.Module\")):\n    def __init__(self, in_features: int, out_features: int, bias: bool = True):\n        super(MyModule, self).__init__()\n        self.linear = [nn.Linear](https://pytorch.org/docs/stable/generated/torch.nn.Linear.html#torch.nn.Linear \"torch.nn.Linear\")(in_features, out_features, bias)\n\n    def forward(self, input, mask):\n        with profiler.record_function(\"LINEAR PASS\"):\n            out = self.linear(input)\n\n        with profiler.record_function(\"MASK INDICES\"):\n            threshold = out.sum(axis=1).mean().item()\n            hi_idx = np.argwhere(mask.cpu().numpy() > threshold)\n            hi_idx = [torch.from_numpy](https://pytorch.org/docs/stable/generated/torch.from_numpy.html#torch.from_numpy \"torch.from_numpy\")(hi_idx).cuda()\n\n        return out, hi_idx \n```", "```py\nmodel = MyModule(500, 10).cuda()\ninput = [torch.rand](https://pytorch.org/docs/stable/generated/torch.rand.html#torch.rand \"torch.rand\")(128, 500).cuda()\nmask = [torch.rand](https://pytorch.org/docs/stable/generated/torch.rand.html#torch.rand \"torch.rand\")((500, 500, 500), dtype=torch.double).cuda()\n\n# warm-up\nmodel(input, mask)\n\nwith [profiler.profile](https://pytorch.org/docs/stable/autograd.html#torch.autograd.profiler.profile \"torch.autograd.profiler.profile\")(with_stack=True, profile_memory=True) as prof:\n    out, idx = model(input, mask) \n```", "```py\nprint(prof.key_averages(group_by_stack_n=5).table(sort_by='self_cpu_time_total', row_limit=5))\n\n\"\"\"\n(Some columns are omitted)\n\n-------------  ------------  ------------  ------------  ---------------------------------\n Name    Self CPU %      Self CPU  Self CPU Mem   Source Location\n-------------  ------------  ------------  ------------  ---------------------------------\n MASK INDICES        87.88%        5.212s    -953.67 Mb  /mnt/xarfuse/.../torch/au\n <ipython-input-...>(10): forward\n /mnt/xarfuse/.../torch/nn\n <ipython-input-...>(9): <module>\n /mnt/xarfuse/.../IPython/\n\n aten::copy_        12.07%     715.848ms           0 b  <ipython-input-...>(12): forward\n /mnt/xarfuse/.../torch/nn\n <ipython-input-...>(9): <module>\n /mnt/xarfuse/.../IPython/\n /mnt/xarfuse/.../IPython/\n\n LINEAR PASS         0.01%     350.151us         -20 b  /mnt/xarfuse/.../torch/au\n <ipython-input-...>(7): forward\n /mnt/xarfuse/.../torch/nn\n <ipython-input-...>(9): <module>\n /mnt/xarfuse/.../IPython/\n\n aten::addmm         0.00%     293.342us           0 b  /mnt/xarfuse/.../torch/nn\n /mnt/xarfuse/.../torch/nn\n /mnt/xarfuse/.../torch/nn\n <ipython-input-...>(8): forward\n /mnt/xarfuse/.../torch/nn\n\n aten::mean         0.00%     235.095us           0 b  <ipython-input-...>(11): forward\n /mnt/xarfuse/.../torch/nn\n <ipython-input-...>(9): <module>\n /mnt/xarfuse/.../IPython/\n /mnt/xarfuse/.../IPython/\n\n-----------------------------  ------------  ---------- ----------------------------------\nSelf CPU time total: 5.931s\n\n\"\"\" \n```", "```py\nmodel = MyModule(500, 10).cuda()\ninput = [torch.rand](https://pytorch.org/docs/stable/generated/torch.rand.html#torch.rand \"torch.rand\")(128, 500).cuda()\nmask = [torch.rand](https://pytorch.org/docs/stable/generated/torch.rand.html#torch.rand \"torch.rand\")((500, 500, 500), dtype=torch.float).cuda()\n\n# warm-up\nmodel(input, mask)\n\nwith [profiler.profile](https://pytorch.org/docs/stable/autograd.html#torch.autograd.profiler.profile \"torch.autograd.profiler.profile\")(with_stack=True, profile_memory=True) as prof:\n    out, idx = model(input, mask)\n\nprint(prof.key_averages(group_by_stack_n=5).table(sort_by='self_cpu_time_total', row_limit=5))\n\n\"\"\"\n(Some columns are omitted)\n\n-----------------  ------------  ------------  ------------  --------------------------------\n Name    Self CPU %      Self CPU  Self CPU Mem   Source Location\n-----------------  ------------  ------------  ------------  --------------------------------\n MASK INDICES        93.61%        5.006s    -476.84 Mb  /mnt/xarfuse/.../torch/au\n <ipython-input-...>(10): forward\n /mnt/xarfuse/  /torch/nn\n <ipython-input-...>(9): <module>\n /mnt/xarfuse/.../IPython/\n\n aten::copy_         6.34%     338.759ms           0 b  <ipython-input-...>(12): forward\n /mnt/xarfuse/.../torch/nn\n <ipython-input-...>(9): <module>\n /mnt/xarfuse/.../IPython/\n /mnt/xarfuse/.../IPython/\n\n aten::as_strided         0.01%     281.808us           0 b  <ipython-input-...>(11): forward\n /mnt/xarfuse/.../torch/nn\n <ipython-input-...>(9): <module>\n /mnt/xarfuse/.../IPython/\n /mnt/xarfuse/.../IPython/\n\n aten::addmm         0.01%     275.721us           0 b  /mnt/xarfuse/.../torch/nn\n /mnt/xarfuse/.../torch/nn\n /mnt/xarfuse/.../torch/nn\n <ipython-input-...>(8): forward\n /mnt/xarfuse/.../torch/nn\n\n aten::_local        0.01%     268.650us           0 b  <ipython-input-...>(11): forward\n _scalar_dense                                          /mnt/xarfuse/.../torch/nn\n <ipython-input-...>(9): <module>\n /mnt/xarfuse/.../IPython/\n /mnt/xarfuse/.../IPython/\n\n-----------------  ------------  ------------  ------------  --------------------------------\nSelf CPU time total: 5.347s\n\n\"\"\" \n```", "```py\nclass MyModule([nn.Module](https://pytorch.org/docs/stable/generated/torch.nn.Module.html#torch.nn.Module \"torch.nn.Module\")):\n    def __init__(self, in_features: int, out_features: int, bias: bool = True):\n        super(MyModule, self).__init__()\n        self.linear = [nn.Linear](https://pytorch.org/docs/stable/generated/torch.nn.Linear.html#torch.nn.Linear \"torch.nn.Linear\")(in_features, out_features, bias)\n\n    def forward(self, input, mask):\n        with profiler.record_function(\"LINEAR PASS\"):\n            out = self.linear(input)\n\n        with profiler.record_function(\"MASK INDICES\"):\n            threshold = out.sum(axis=1).mean()\n            hi_idx = (mask > threshold).nonzero(as_tuple=True)\n\n        return out, hi_idx\n\nmodel = MyModule(500, 10).cuda()\ninput = [torch.rand](https://pytorch.org/docs/stable/generated/torch.rand.html#torch.rand \"torch.rand\")(128, 500).cuda()\nmask = [torch.rand](https://pytorch.org/docs/stable/generated/torch.rand.html#torch.rand \"torch.rand\")((500, 500, 500), dtype=torch.float).cuda()\n\n# warm-up\nmodel(input, mask)\n\nwith [profiler.profile](https://pytorch.org/docs/stable/autograd.html#torch.autograd.profiler.profile \"torch.autograd.profiler.profile\")(with_stack=True, profile_memory=True) as prof:\n    out, idx = model(input, mask)\n\nprint(prof.key_averages(group_by_stack_n=5).table(sort_by='self_cpu_time_total', row_limit=5))\n\n\"\"\"\n(Some columns are omitted)\n\n--------------  ------------  ------------  ------------  ---------------------------------\n Name    Self CPU %      Self CPU  Self CPU Mem   Source Location\n--------------  ------------  ------------  ------------  ---------------------------------\n aten::gt        57.17%     129.089ms           0 b  <ipython-input-...>(12): forward\n /mnt/xarfuse/.../torch/nn\n <ipython-input-...>(25): <module>\n /mnt/xarfuse/.../IPython/\n /mnt/xarfuse/.../IPython/\n\n aten::nonzero        37.38%      84.402ms           0 b  <ipython-input-...>(12): forward\n /mnt/xarfuse/.../torch/nn\n <ipython-input-...>(25): <module>\n /mnt/xarfuse/.../IPython/\n /mnt/xarfuse/.../IPython/\n\n INDEX SCORE         3.32%       7.491ms    -119.21 Mb  /mnt/xarfuse/.../torch/au\n <ipython-input-...>(10): forward\n /mnt/xarfuse/.../torch/nn\n <ipython-input-...>(25): <module>\n /mnt/xarfuse/.../IPython/\n\naten::as_strided         0.20%    441.587us          0 b  <ipython-input-...>(12): forward\n /mnt/xarfuse/.../torch/nn\n <ipython-input-...>(25): <module>\n /mnt/xarfuse/.../IPython/\n /mnt/xarfuse/.../IPython/\n\n aten::nonzero\n _numpy             0.18%     395.602us           0 b  <ipython-input-...>(12): forward\n /mnt/xarfuse/.../torch/nn\n <ipython-input-...>(25): <module>\n /mnt/xarfuse/.../IPython/\n /mnt/xarfuse/.../IPython/\n--------------  ------------  ------------  ------------  ---------------------------------\nSelf CPU time total: 225.801ms\n\n\"\"\" \n```"]